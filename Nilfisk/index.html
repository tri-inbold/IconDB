<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nilfisk Icon Hub</title>
<style>
  :root {
    --nilfisk-light: #EFF0F2;
    --nilfisk-dark: #28313F;
    --nilfisk-pro-blue: #38AFD9;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f5f5f5; color: #2c2c2c; overflow: hidden;
  }
  #loginScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--nilfisk-dark); display: flex; align-items: center; justify-content: center; z-index: 10000;
  }
  .login-card {
    background: white; padding: 40px; border-radius: 12px; text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
  }
  .btn-google {
    background: #4285F4; color: white; border: none; padding: 12px 24px;
    border-radius: 4px; font-weight: 600; cursor: pointer; margin-top: 20px; width: 100%;
  }
  #mainApp { display: none; height: 100vh; flex-direction: column; }
  .header {
    background: white; border-bottom: 1px solid #e0e0e0;
    padding: 16px 24px; display: flex; align-items: center; gap: 16px; flex-shrink: 0;
  }
  .header h1 { font-size: 20px; font-weight: 600; }
  .search-box { flex: 1; max-width: 500px; }
  .search-box input { width: 100%; padding: 8px 12px; border: 1px solid #d0d0d0; border-radius: 4px; font-size: 14px; }
  .main-content { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 240px; background: white; border-right: 1px solid #e0e0e0; overflow-y: auto; flex-shrink: 0; }
  .sidebar-section { padding: 16px; border-bottom: 1px solid #e0e0e0; }
  .sidebar-section h3 { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #999; margin-bottom: 12px; }
  .collection-item, .swatch-item {
    padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 14px;
    display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
  }
  .collection-item:hover, .swatch-item:hover { background: #f5f5f5; }
  .collection-item.active { background: #e3f2fd; color: #1976d2; font-weight: 600; }
  .swatch-color { width: 18px; height: 18px; border-radius: 3px; border: 1px solid #ddd; }
  .icon-grid-container { flex: 1; overflow-y: auto; padding: 24px; background: #fafafa; }
  .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 16px; }
  .icon-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 12px; cursor: pointer; text-align: center; transition: 0.2s; }
  .icon-card:hover { border-color: var(--nilfisk-pro-blue); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  .icon-card.selected { border: 2px solid var(--nilfisk-pro-blue); background: #f0f9fd; }
  .icon-preview {
    width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
    margin-bottom: 8px; background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
    background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px; border-radius: 4px;
  }
  .icon-preview img { max-width: 75%; max-height: 75%; display: block; }
  .icon-name { font-size: 11px; font-weight: 500; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .detail-panel { width: 340px; background: white; border-left: 1px solid #e0e0e0; overflow-y: auto; display: none; }
  .detail-panel.show { display: block; }
  .detail-section { padding: 20px; border-bottom: 1px solid #f0f0f0; }
  .detail-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #666; }
  .canvas-preview { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 12px; }
  .canvas-preview.checker { background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%); background-size: 20px 20px; }
  .canvas-preview img { max-width: 85%; max-height: 85%; }
  .color-item { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; }
  .color-preview { width: 28px; height: 28px; border-radius: 4px; border: 1px solid #ddd; }
  .tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 11px; margin: 2px; }
  .tag-chip button { background: none; border: none; cursor: pointer; color: inherit; font-size: 14px; }
  .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--nilfisk-pro-blue); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(56, 175, 217, 0.4); }
  .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 2000; align-items: center; justify-content: center; }
  .modal.show { display: flex; }
  .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 450px; width: 90%; }
  .context-menu { position: fixed; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: none; z-index: 3000; min-width: 160px; padding: 5px 0; }
  .context-menu-item { padding: 10px 20px; cursor: pointer; font-size: 13px; color: #333; }
  .context-menu-item:hover { background: #f0f7ff; color: #1976d2; }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-card">
    <img src="https://www.nilfisk.com/PublishingImages/nilfisk-logo.svg" width="120" style="margin-bottom: 20px;">
    <h2>Icon Database</h2>
    <p id="authMsg" style="margin-top: 10px; color: #666; font-size: 14px;">Sign in with company account</p>
    <button class="btn-google" id="loginBtn">Sign in with Google</button>
  </div>
</div>

<div id="mainApp">
  <div class="header">
    <h1>Nilfisk Hub</h1>
    <div class="search-box"><input type="text" id="searchInput" placeholder="Search by name, Tag:&quot;...&quot; or Collection:&quot;...&quot;"></div>
    <button id="logoutBtn" style="padding: 6px 12px; cursor: pointer; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">Logout</button>
  </div>
  <div class="main-content">
    <div class="sidebar">
      <div class="sidebar-section"><h3>Collections</h3><div id="colList"></div><button style="border:none; background:none; color:var(--nilfisk-pro-blue); font-size:12px; cursor:pointer; margin-top:10px" id="addColBtn">+ Add New</button></div>
      <div class="sidebar-section"><h3>Swatches</h3><div id="swatchList"></div><button style="border:none; background:none; color:var(--nilfisk-pro-blue); font-size:12px; cursor:pointer; margin-top:10px" id="addSwatchBtn">+ Add Swatch</button></div>
    </div>
    <div class="icon-grid-container"><div class="icon-grid" id="iconGrid"></div></div>
    <div class="detail-panel" id="detailPanel">
      <div class="detail-section">
        <h3>Preview</h3>
        <div class="canvas-preview checker" id="previewBox"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
          <button id="copySvgBtn" style="padding:8px; cursor:pointer; border:1px solid #ddd; background:white; border-radius:4px; font-size:12px">Copy SVG</button>
          <button id="delIconBtn" style="padding:8px; cursor:pointer; border:1px solid #ffcdd2; background:#fff5f5; color:#d32f2f; border-radius:4px; font-size:12px">Delete</button>
        </div>
      </div>
      <div class="detail-section"><h3>Name</h3><input type="text" id="editName" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:13px"></div>
      <div class="detail-section"><h3>Tags</h3><div id="tagContainer"></div><input type="text" id="tagInput" placeholder="Press Enter to add tag..." style="width:100%; margin-top:8px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:13px"></div>
      <div class="detail-section"><h3>Colors</h3><div id="colorList"></div></div>
      <div class="detail-section"><h3>Stroke Info</h3><div id="strokeList"></div></div>
    </div>
  </div>
  <button class="fab" id="addIconBtn">+</button>
</div>

<div class="modal" id="uploadModal">
  <div class="modal-content">
    <h3 style="margin-bottom:15px">Upload Icon</h3>
    <input type="text" id="upName" placeholder="Icon Name" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px;">
    <select id="upCol" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px;"></select>
    <div id="dropZone" style="border:2px dashed #ddd; border-radius:8px; padding:40px; text-align:center; cursor:pointer; color:#999; margin-bottom:15px">Click or Drop SVG</div>
    <input type="file" id="fileInput" accept=".svg" style="display:none">
    <button class="btn-google" id="doUpload">Upload to Cloud</button>
    <button style="width:100%; border:none; background:none; color:#999; margin-top:10px; cursor:pointer" onclick="document.getElementById('uploadModal').classList.remove('show')">Cancel</button>
  </div>
</div>

<div class="context-menu" id="ctxMenu"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, deleteField, collection } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAsv8v9b7YXgt7315B6184e9E85QCL9Qfs",
    authDomain: "icondb-28ddd.firebaseapp.com",
    projectId: "icondb-28ddd",
    storageBucket: "icondb-28ddd.firebasestorage.app",
    messagingSenderId: "145146058112",
    appId: "1:145146058112:web:2aed071e107cf7d4e71d65"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let state = { icons: [], swatches: [], collections: [], selected: null, activeCol: 'All Icons', query: '' };

  document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const accDoc = await getDoc(doc(db, "Nilfisk", "Accounts"));
      if (Object.values(accDoc.data() || {}).includes(user.email)) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        loadData();
      } else {
        document.getElementById('authMsg').textContent = "Access Denied: " + user.email;
        signOut(auth);
      }
    } else {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }
  });

  async function loadData() {
    state.icons = [];
    const colSnap = await getDocs(collection(db, "Nilfisk"));
    colSnap.forEach(docSnap => {
      const docId = docSnap.id;
      if (['Accounts', 'Swatches', 'Collections'].includes(docId)) {
        if (docId === 'Swatches') state.swatches = Object.entries(docSnap.data()).map(([n, c]) => ({ name: n, color: c }));
        if (docId === 'Collections') state.collections = docSnap.data().list || ['All Icons'];
      } else {
        Object.entries(docSnap.data()).forEach(([name, data]) => {
          state.icons.push({ 
            name, 
            svg: typeof data === 'string' ? data : data.svg, 
            tags: data.tags || [], 
            primaryCol: docId,
            cols: [docId, 'All Icons']
          });
        });
      }
    });
    render();
  }

  function render() {
    const grid = document.getElementById('iconGrid');
    grid.innerHTML = '';
    const filtered = state.icons.filter(i => {
      const mCol = state.activeCol === 'All Icons' || i.cols.includes(state.activeCol);
      const mQuery = i.name.toLowerCase().includes(state.query.toLowerCase()) || 
                     i.tags.some(t => t.toLowerCase().includes(state.query.toLowerCase()));
      return mCol && mQuery;
    });

    filtered.forEach(icon => {
      const card = document.createElement('div');
      card.className = 'icon-card' + (state.selected?.name === icon.name ? ' selected' : '');
      card.innerHTML = `<div class="icon-preview"><img src="${icon.svg}"></div><div class="icon-name">${icon.name}</div>`;
      card.onclick = () => { state.selected = icon; render(); showDetail(); };
      card.oncontextmenu = (e) => { e.preventDefault(); showIconCtx(e.clientX, e.clientY, icon); };
      grid.appendChild(card);
    });

    const cList = document.getElementById('colList');
    cList.innerHTML = '';
    state.collections.forEach(c => {
      const div = document.createElement('div');
      div.className = 'collection-item' + (state.activeCol === c ? ' active' : '');
      div.textContent = c;
      div.onclick = () => { state.activeCol = c; render(); };
      div.oncontextmenu = (e) => { e.preventDefault(); if(c !== 'All Icons') showColCtx(e.clientX, e.clientY, c); };
      cList.appendChild(div);
    });

    const sList = document.getElementById('swatchList');
    sList.innerHTML = '';
    state.swatches.forEach(s => {
      const div = document.createElement('div');
      div.className = 'swatch-item';
      div.innerHTML = `<div class="swatch-color" style="background:${s.color}"></div><span>${s.name}</span>`;
      div.oncontextmenu = (e) => { e.preventDefault(); showSwatchCtx(e.clientX, e.clientY, s); };
      sList.appendChild(div);
    });

    const upCol = document.getElementById('upCol');
    upCol.innerHTML = state.collections.filter(c => c !== 'All Icons').map(c => `<option value="${c}">${c}</option>`).join('');
  }

  function showDetail() {
    const icon = state.selected;
    document.getElementById('detailPanel').classList.add('show');
    document.getElementById('previewBox').innerHTML = `<img src="${icon.svg}">`;
    document.getElementById('editName').value = icon.name;
    
    const tags = document.getElementById('tagContainer');
    tags.innerHTML = icon.tags.map(t => `<span class="tag-chip">${t}<button onclick="removeTag('${t}')">Ã—</button></span>`).join('');
    
    detectSVGInfo(icon.svg);
  }

  function detectSVGInfo(svgData) {
    const raw = atob(svgData.split(',')[1]);
    const temp = document.createElement('div');
    temp.style.display = 'none';
    temp.innerHTML = raw;
    document.body.appendChild(temp);
    const svgEl = temp.querySelector('svg');

    const colors = { f: new Set(), s: new Set() };
    const strokes = new Set();

    svgEl.querySelectorAll('*').forEach(el => {
      const style = window.getComputedStyle(el);
      if (style.fill !== 'none' && style.fill.startsWith('rgb')) colors.f.add(rgbToHex(style.fill));
      if (style.stroke !== 'none' && style.stroke.startsWith('rgb')) colors.s.add(rgbToHex(style.stroke));
      if (parseFloat(style.strokeWidth) > 0) strokes.add(style.strokeWidth);
    });

    const cList = document.getElementById('colorList');
    cList.innerHTML = '';
    [...colors.f].forEach(c => addColorRow(c, 'Fill', cList));
    [...colors.s].forEach(c => addColorRow(c, 'Stroke', cList));

    const sList = document.getElementById('strokeList');
    sList.innerHTML = [...strokes].map(s => `<div style="font-size:12px; margin-bottom:4px">Width: <b>${s}</b></div>`).join('');
    
    document.body.removeChild(temp);
  }

  function addColorRow(hex, type, container) {
    const div = document.createElement('div');
    div.className = 'color-item';
    div.innerHTML = `
      <div class="color-preview" style="background:${hex}"></div>
      <div style="flex:1; font-size:11px"><b>${type}</b>: ${hex}</div>
      <select style="font-size:11px; padding:2px"><option value="">Swap...</option>${state.swatches.map(s => `<option value="${s.color}">${s.name}</option>`).join('')}</select>
    `;
    div.querySelector('select').onchange = (e) => { if(e.target.value) swapColor(hex, e.target.value); };
    container.appendChild(div);
  }

  function swapColor(oldHex, newHex) {
    let raw = atob(state.selected.svg.split(',')[1]);
    raw = raw.replace(new RegExp(oldHex, 'gi'), newHex);
    state.selected.svg = 'data:image/svg+xml;base64,' + btoa(raw);
    saveIconToCloud();
    showDetail();
    render();
  }

  window.removeTag = (tag) => {
    state.selected.tags = state.selected.tags.filter(t => t !== tag);
    saveIconToCloud();
    showDetail();
  };

  async function saveIconToCloud() {
    const icon = state.selected;
    await updateDoc(doc(db, "Nilfisk", icon.primaryCol), {
      [icon.name]: { svg: icon.svg, tags: icon.tags }
    });
  }

  function rgbToHex(rgb) {
    const match = rgb.match(/\d+/g);
    return "#" + match.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('').toUpperCase();
  }

  function showIconCtx(x, y, icon) {
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px';
    menu.innerHTML = `<div class="context-menu-item" id="ctxCopy">Copy SVG</div><div class="context-menu-item" id="ctxDel" style="color:red">Delete Icon</div>`;
    document.getElementById('ctxCopy').onclick = () => { navigator.clipboard.writeText(atob(icon.svg.split(',')[1])); menu.style.display = 'none'; };
    document.getElementById('ctxDel').onclick = () => { deleteIcon(icon); menu.style.display = 'none'; };
  }

  async function deleteIcon(icon) {
    if(confirm(`Delete ${icon.name}?`)) {
      await updateDoc(doc(db, "Nilfisk", icon.primaryCol), { [icon.name]: deleteField() });
      state.icons = state.icons.filter(i => i.name !== icon.name);
      state.selected = null; render();
      document.getElementById('detailPanel').classList.remove('show');
    }
  }

  function showColCtx(x, y, col) {
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px';
    menu.innerHTML = `<div class="context-menu-item" style="color:red">Delete Collection</div>`;
    menu.querySelector('div').onclick = async () => {
      if(confirm(`Delete collection ${col}? Icons inside will be hidden.`)) {
        state.collections = state.collections.filter(c => c !== col);
        await setDoc(doc(db, "Nilfisk", "Collections"), { list: state.collections });
        render(); menu.style.display = 'none';
      }
    };
  }

  function showSwatchCtx(x, y, s) {
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px';
    menu.innerHTML = `<div class="context-menu-item" style="color:red">Delete Swatch</div>`;
    menu.querySelector('div').onclick = async () => {
      await updateDoc(doc(db, "Nilfisk", "Swatches"), { [s.name]: deleteField() });
      state.swatches = state.swatches.filter(sw => sw.name !== s.name);
      render(); menu.style.display = 'none';
    };
  }

  document.getElementById('tagInput').onkeydown = (e) => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      state.selected.tags.push(e.target.value.trim());
      e.target.value = ''; saveIconToCloud(); showDetail();
    }
  };

  document.getElementById('addIconBtn').onclick = () => document.getElementById('uploadModal').classList.add('show');
  document.getElementById('dropZone').onclick = () => document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (ev) => { state.tempSvg = 'data:image/svg+xml;base64,' + btoa(ev.target.result); document.getElementById('upName').value = file.name.replace('.svg',''); };
    reader.readAsText(file);
  };

  document.getElementById('doUpload').onclick = async () => {
    const name = document.getElementById('upName').value;
    const col = document.getElementById('upCol').value;
    if (name && state.tempSvg && col) {
      await updateDoc(doc(db, "Nilfisk", col), { [name]: { svg: state.tempSvg, tags: [] } });
      document.getElementById('uploadModal').classList.remove('show');
      loadData();
    }
  };

  document.getElementById('addColBtn').onclick = async () => {
    const n = prompt('Collection name:');
    if (n && !state.collections.includes(n)) {
      state.collections.push(n);
      await setDoc(doc(db, "Nilfisk", "Collections"), { list: state.collections });
      render();
    }
  };

  document.getElementById('addSwatchBtn').onclick = async () => {
    const n = prompt('Swatch name:');
    const c = prompt('Hex color:', '#000000');
    if (n && c) {
      await updateDoc(doc(db, "Nilfisk", "Swatches"), { [n]: c });
      state.swatches.push({ name: n, color: c });
      render();
    }
  };

  document.getElementById('searchInput').oninput = (e) => { state.query = e.target.value; render(); };
  document.getElementById('copySvgBtn').onclick = () => { navigator.clipboard.writeText(atob(state.selected.svg.split(',')[1])); alert('SVG Copied!'); };
  document.addEventListener('click', () => document.getElementById('ctxMenu').style.display = 'none');
</script>
</body>
</html>
