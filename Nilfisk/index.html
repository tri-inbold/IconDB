<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nilfisk Icon Hub</title>
<style>
  :root {
    --nilfisk-light: #EFF0F2;
    --nilfisk-dark: #28313F;
    --nilfisk-pro-blue: #38AFD9;
    --nilfisk-consumer-blue: #0050B5;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f5f5f5;
    color: #2c2c2c;
    overflow: hidden;
  }
  #loginScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--nilfisk-dark);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  }
  .login-card {
    background: white; padding: 40px; border-radius: 12px; text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
  }
  .btn-google {
    background: #4285F4; color: white; border: none; padding: 12px 24px;
    border-radius: 4px; font-weight: 600; cursor: pointer; margin-top: 20px; width: 100%;
  }
  #mainApp { display: none; height: 100vh; flex-direction: column; }
  .header {
    background: white; border-bottom: 1px solid #e0e0e0;
    padding: 16px 24px; display: flex; align-items: center; gap: 16px; flex-shrink: 0;
  }
  .header h1 { font-size: 20px; font-weight: 600; }
  .search-box { flex: 1; max-width: 500px; }
  .search-box input { width: 100%; padding: 8px 12px; border: 1px solid #d0d0d0; border-radius: 4px; }
  .main-content { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 240px; background: white; border-right: 1px solid #e0e0e0; overflow-y: auto; flex-shrink: 0; }
  .sidebar-section { padding: 16px; border-bottom: 1px solid #e0e0e0; }
  .sidebar-section h3 { font-size: 12px; font-weight: 600; text-transform: uppercase; color: #6e6e6e; margin-bottom: 12px; }
  .collection-item, .swatch-item {
    padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 14px;
    display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
  }
  .collection-item:hover, .swatch-item:hover { background: #f5f5f5; }
  .collection-item.active { background: #e3f2fd; color: #1976d2; }
  .swatch-color { width: 20px; height: 20px; border-radius: 3px; border: 1px solid #e0e0e0; }
  .add-btn {
    width: 100%; padding: 8px; background: transparent; border: 1px dashed #d0d0d0;
    border-radius: 4px; cursor: pointer; font-size: 14px; color: #6e6e6e; margin-top: 8px;
  }
  .icon-grid-container { flex: 1; overflow-y: auto; padding: 24px; }
  .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; }
  .icon-card { background: white; border: 2px solid transparent; border-radius: 8px; padding: 16px; cursor: pointer; text-align: center; }
  .icon-card:hover { border-color: #d0d0d0; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .icon-card.selected { border-color: var(--nilfisk-pro-blue); background: #f0f9fd; }
  .icon-preview {
    width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
    margin-bottom: 8px; background: linear-gradient(45deg, #f5f5f5 25%, transparent 25%), linear-gradient(-45deg, #f5f5f5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f5f5f5 75%), linear-gradient(-45deg, transparent 75%, #f5f5f5 75%);
    background-size: 16px 16px; background-position: 0 0, 0 8px, 8px -8px, -8px 0px; border-radius: 4px;
  }
  .icon-preview img { max-width: 80%; max-height: 80%; }
  .icon-name { font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .detail-panel { width: 360px; background: white; border-left: 1px solid #e0e0e0; overflow-y: auto; display: none; }
  .detail-panel.show { display: block; }
  .detail-section { padding: 20px; border-bottom: 1px solid #e0e0e0; }
  .detail-section h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
  .canvas-preview { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 12px; }
  .canvas-preview.checker { background: linear-gradient(45deg, #f5f5f5 25%, transparent 25%), linear-gradient(-45deg, #f5f5f5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f5f5f5 75%), linear-gradient(-45deg, transparent 75%, #f5f5f5 75%); background-size: 20px 20px; }
  .canvas-preview img { max-width: 90%; max-height: 90%; }
  .export-buttons { display: flex; gap: 8px; margin-bottom: 16px; }
  .export-buttons button { flex: 1; padding: 8px; background: white; border: 1px solid #d0d0d0; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }
  .color-item { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px; }
  .color-preview { width: 32px; height: 32px; border-radius: 4px; border: 1px solid #d0d0d0; }
  .tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 12px; margin: 2px; }
  .tag-chip button { background: none; border: none; cursor: pointer; color: inherit; font-size: 14px; }
  .fab { position: fixed; bottom: 32px; right: 32px; width: 56px; height: 56px; background: var(--nilfisk-pro-blue); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
  .modal.show { display: flex; }
  .modal-content { background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%; }
  .context-menu { position: fixed; background: white; border: 1px solid #d0d0d0; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; z-index: 2000; min-width: 150px; }
  .context-menu-item { padding: 10px 16px; cursor: pointer; font-size: 14px; }
  .context-menu-item:hover { background: #f5f5f5; }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-card">
    <img src="https://www.nilfisk.com/PublishingImages/nilfisk-logo.svg" width="120" style="margin-bottom: 20px;">
    <h2>Icon Database</h2>
    <p id="authMsg" style="margin-top: 10px; color: #666; font-size: 14px;">Please sign in to continue</p>
    <button class="btn-google" id="loginBtn">Sign in with Google</button>
  </div>
</div>

<div id="mainApp">
  <div class="header">
    <h1>Nilfisk Icons</h1>
    <div class="search-box"><input type="text" id="searchInput" placeholder="Search icons..."></div>
    <button id="logoutBtn" style="padding: 8px 16px; cursor: pointer; background: none; border: 1px solid #d0d0d0; border-radius: 4px;">Logout</button>
  </div>
  <div class="main-content">
    <div class="sidebar">
      <div class="sidebar-section"><h3>Collections</h3><div id="colList"></div><button class="add-btn" id="addColBtn">+ Add</button></div>
      <div class="sidebar-section"><h3>Swatches</h3><div id="swatchList"></div><button class="add-btn" id="addSwatchBtn">+ Add</button></div>
    </div>
    <div class="icon-grid-container"><div class="icon-grid" id="iconGrid"></div></div>
    <div class="detail-panel" id="detailPanel">
      <div class="detail-section">
        <h3>Preview</h3>
        <div class="canvas-preview checker" id="previewBox"></div>
        <div class="export-buttons">
          <button id="copySvgBtn">Copy SVG</button>
          <button id="dlPngBtn">PNG</button>
          <button id="dlJpgBtn">JPG</button>
        </div>
      </div>
      <div class="detail-section">
        <h3>Details</h3>
        <input type="text" id="editName" style="width:100%; padding:8px; border:1px solid #d0d0d0; border-radius:4px;">
      </div>
      <div class="detail-section"><h3>Tags</h3><div id="tagContainer"></div><input type="text" id="tagInput" placeholder="Add tag..." style="width:100%; margin-top:8px; padding:8px; border:1px solid #d0d0d0; border-radius:4px;"></div>
      <div class="detail-section"><h3>Colors</h3><div id="colorList"></div></div>
      <div class="detail-section"><h3>Stroke</h3><div id="strokeList"></div></div>
    </div>
  </div>
  <button class="fab" id="addIconBtn">+</button>
</div>

<div class="modal" id="uploadModal">
  <div class="modal-content">
    <h2 style="margin-bottom:15px">Upload Icon</h2>
    <input type="text" id="upName" placeholder="Icon Name" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
    <div id="dropZone" style="border:2px dashed #ccc; padding:30px; text-align:center; cursor:pointer; margin-bottom:15px">Click or Drop SVG</div>
    <input type="file" id="fileInput" accept=".svg" style="display:none">
    <textarea id="svgPaste" placeholder="Or paste SVG code here" style="width:100%; height:100px; padding:10px; border:1px solid #ccc; border-radius:4px; margin-bottom:15px"></textarea>
    <button class="btn-google" id="doUpload">Upload</button>
    <button class="add-btn" onclick="document.getElementById('uploadModal').classList.remove('show')">Cancel</button>
  </div>
</div>

<div class="context-menu" id="ctxMenu"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAsv8v9b7YXgt7315B6184e9E85QCL9Qfs",
    authDomain: "icondb-28ddd.firebaseapp.com",
    projectId: "icondb-28ddd",
    storageBucket: "icondb-28ddd.firebasestorage.app",
    messagingSenderId: "145146058112",
    appId: "1:145146058112:web:2aed071e107cf7d4e71d65"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let state = { icons: [], swatches: [], collections: [], selected: null, activeCol: 'All Icons', query: '' };

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authMsg = document.getElementById('authMsg');

  loginBtn.onclick = () => {
    signInWithPopup(auth, provider).catch(e => authMsg.textContent = e.message);
  };

  logoutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const accDoc = await getDoc(doc(db, "Nilfisk", "Accounts"));
      const allowed = Object.values(accDoc.data() || {});
      if (allowed.includes(user.email)) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        loadData();
      } else {
        authMsg.textContent = "Access Denied";
        signOut(auth);
      }
    } else {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }
  });

  async function loadData() {
    const icDoc = await getDoc(doc(db, "Nilfisk", "Icons"));
    state.icons = Object.entries(icDoc.data() || {}).map(([n, s]) => ({ name: n, svg: s, tags: [], cols: ['All Icons'] }));
    const swDoc = await getDoc(doc(db, "Nilfisk", "Swatches"));
    state.swatches = Object.entries(swDoc.data() || {}).map(([n, c]) => ({ name: n, color: c }));
    const colDoc = await getDoc(doc(db, "Nilfisk", "Collections"));
    state.collections = colDoc.exists() ? colDoc.data().list : ['All Icons', 'Product', 'UI'];
    render();
  }

  function render() {
    const grid = document.getElementById('iconGrid');
    grid.innerHTML = '';
    const filtered = state.icons.filter(i => {
      const matchCol = state.activeCol === 'All Icons' || i.cols.includes(state.activeCol);
      const matchQuery = i.name.toLowerCase().includes(state.query.toLowerCase());
      return matchCol && matchQuery;
    });
    filtered.forEach(icon => {
      const card = document.createElement('div');
      card.className = 'icon-card' + (state.selected?.name === icon.name ? ' selected' : '');
      card.innerHTML = `<div class="icon-preview"><img src="${icon.svg}"></div><div class="icon-name">${icon.name}</div>`;
      card.onclick = () => { state.selected = icon; render(); showDetail(); };
      card.oncontextmenu = (e) => { e.preventDefault(); showCtx(e.clientX, e.clientY, icon); };
      grid.appendChild(card);
    });

    const cList = document.getElementById('colList');
    cList.innerHTML = '';
    state.collections.forEach(c => {
      const div = document.createElement('div');
      div.className = 'collection-item' + (state.activeCol === c ? ' active' : '');
      div.textContent = c;
      div.onclick = () => { state.activeCol = c; render(); };
      div.oncontextmenu = (e) => { e.preventDefault(); if(c !== 'All Icons') showColCtx(e.clientX, e.clientY, c); };
      cList.appendChild(div);
    });

    const sList = document.getElementById('swatchList');
    sList.innerHTML = '';
    state.swatches.forEach(s => {
      const div = document.createElement('div');
      div.className = 'swatch-item';
      div.innerHTML = `<div class="swatch-color" style="background:${s.color}"></div><span>${s.name}</span>`;
      div.oncontextmenu = (e) => { e.preventDefault(); showSwatchCtx(e.clientX, e.clientY, s); };
      sList.appendChild(div);
    });
  }

  function showDetail() {
    const panel = document.getElementById('detailPanel');
    panel.classList.add('show');
    const icon = state.selected;
    document.getElementById('previewBox').innerHTML = `<img src="${icon.svg}">`;
    document.getElementById('editName').value = icon.name;
    const tags = document.getElementById('tagContainer');
    tags.innerHTML = '';
    icon.tags.forEach(t => {
      const span = document.createElement('span');
      span.className = 'tag-chip';
      span.innerHTML = `${t}<button>Ã—</button>`;
      span.querySelector('button').onclick = () => { icon.tags = icon.tags.filter(x => x !== t); showDetail(); };
      tags.appendChild(span);
    });

    const temp = document.createElement('div');
    temp.style.position = 'absolute'; temp.style.visibility = 'hidden';
    temp.innerHTML = atob(icon.svg.split(',')[1]);
    document.body.appendChild(temp);
    const svgEl = temp.querySelector('svg');
    
    const colors = { f: new Set(), s: new Set() };
    svgEl.querySelectorAll('*').forEach(el => {
      const style = window.getComputedStyle(el);
      if (style.fill !== 'none' && style.fill.startsWith('rgb')) colors.f.add(rgbToHex(style.fill));
      if (style.stroke !== 'none' && style.stroke.startsWith('rgb')) colors.s.add(rgbToHex(style.stroke));
    });

    const strokes = new Set();
    svgEl.querySelectorAll('*').forEach(el => {
      const sw = window.getComputedStyle(el).strokeWidth;
      if (parseFloat(sw) > 0) strokes.add(sw);
    });

    const cList = document.getElementById('colorList');
    cList.innerHTML = '';
    [...colors.f].forEach(c => addColorRow(c, 'Fill', cList));
    [...colors.s].forEach(c => addColorRow(c, 'Stroke', cList));

    const sList = document.getElementById('strokeList');
    sList.innerHTML = [...strokes].map(s => `<div style="font-size:12px">Width: ${s}</div>`).join('');
    
    document.body.removeChild(temp);
  }

  function addColorRow(hex, type, container) {
    const div = document.createElement('div');
    div.className = 'color-item';
    div.innerHTML = `
      <div class="color-preview" style="background:${hex}"></div>
      <div style="flex:1; font-size:12px"><b>${type}</b><br>${hex}</div>
      <select style="font-size:11px">
        <option>Swap to...</option>
        ${state.swatches.map(s => `<option value="${s.color}">${s.name}</option>`).join('')}
      </select>
    `;
    div.querySelector('select').onchange = (e) => swapColor(hex, e.target.value);
    container.appendChild(div);
  }

  function swapColor(oldHex, newHex) {
    let raw = atob(state.selected.svg.split(',')[1]);
    const reg = new RegExp(oldHex, 'gi');
    raw = raw.replace(reg, newHex);
    state.selected.svg = 'data:image/svg+xml;base64,' + btoa(raw);
    saveIcon(state.selected);
    showDetail();
    render();
  }

  function rgbToHex(rgb) {
    const [r, g, b] = rgb.match(/\d+/g);
    return "#" + [r, g, b].map(x => parseInt(x).toString(16).padStart(2, '0')).join('').toUpperCase();
  }

  async function saveIcon(icon) {
    await updateDoc(doc(db, "Nilfisk", "Icons"), { [icon.name]: icon.svg });
  }

  function showCtx(x, y, icon) {
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px';
    menu.innerHTML = `
      <div class="context-menu-item" id="ctxCopy">Copy as SVG</div>
      <div class="context-menu-item" id="ctxDel" style="color:red">Delete</div>
    `;
    document.getElementById('ctxCopy').onclick = () => {
      const raw = atob(icon.svg.split(',')[1]);
      navigator.clipboard.writeText(raw); menu.style.display = 'none';
    };
    document.getElementById('ctxDel').onclick = async () => {
      if (confirm('Delete icon?')) {
        await updateDoc(doc(db, "Nilfisk", "Icons"), { [icon.name]: deleteField() });
        state.icons = state.icons.filter(i => i.name !== icon.name);
        render(); document.getElementById('detailPanel').classList.remove('show');
      }
      menu.style.display = 'none';
    };
  }

  function showColCtx(x, y, col) {
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px';
    menu.innerHTML = `<div class="context-menu-item" style="color:red">Delete Collection</div>`;
    menu.querySelector('div').onclick = async () => {
      state.collections = state.collections.filter(c => c !== col);
      await setDoc(doc(db, "Nilfisk", "Collections"), { list: state.collections });
      render(); menu.style.display = 'none';
    };
  }

  function showSwatchCtx(x, y, swatch) {
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px';
    menu.innerHTML = `<div class="context-menu-item" style="color:red">Delete Swatch</div>`;
    menu.querySelector('div').onclick = async () => {
      await updateDoc(doc(db, "Nilfisk", "Swatches"), { [swatch.name]: deleteField() });
      state.swatches = state.swatches.filter(s => s.name !== swatch.name);
      render(); menu.style.display = 'none';
    };
  }

  document.getElementById('searchInput').oninput = (e) => { state.query = e.target.value; render(); };
  document.getElementById('tagInput').onkeydown = (e) => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      state.selected.tags.push(e.target.value.trim());
      e.target.value = ''; showDetail();
    }
  };

  document.getElementById('addIconBtn').onclick = () => document.getElementById('uploadModal').classList.add('show');
  document.getElementById('dropZone').onclick = () => document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (ev) => { document.getElementById('svgPaste').value = ev.target.result; if(!document.getElementById('upName').value) document.getElementById('upName').value = file.name.replace('.svg',''); };
    reader.readAsText(file);
  };
  document.getElementById('doUpload').onclick = async () => {
    const name = document.getElementById('upName').value;
    const raw = document.getElementById('svgPaste').value;
    if (name && raw) {
      const b64 = 'data:image/svg+xml;base64,' + btoa(raw);
      await updateDoc(doc(db, "Nilfisk", "Icons"), { [name]: b64 });
      state.icons.push({ name, svg: b64, tags: [], cols: ['All Icons'] });
      document.getElementById('uploadModal').classList.remove('show');
      render();
    }
  };

  document.getElementById('addColBtn').onclick = async () => {
    const n = prompt('Collection name:');
    if (n) { state.collections.push(n); await setDoc(doc(db, "Nilfisk", "Collections"), { list: state.collections }); render(); }
  };
  document.getElementById('addSwatchBtn').onclick = async () => {
    const n = prompt('Swatch name:');
    const c = prompt('Hex color:', '#000000');
    if (n && c) { await updateDoc(doc(db, "Nilfisk", "Swatches"), { [n]: c }); state.swatches.push({ name: n, color: c }); render(); }
  };

  document.getElementById('copySvgBtn').onclick = () => navigator.clipboard.writeText(atob(state.selected.svg.split(',')[1]));
  document.addEventListener('click', (e) => { if (!e.target.closest('.context-menu')) document.getElementById('ctxMenu').style.display = 'none'; });
</script>
</body>
</html>
